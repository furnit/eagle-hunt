<p><span class="fa fa-check"></span> <strong>لطفا اندازه و تعداد مبلمان مورد سفارش خود را تعریف کنید.</strong></p>
<table class="table">
	<tbody>
		<tr>
			<td><strong>ست پیش‌فرض</strong></td>
			<td>
				<select class="selectpicker" data-size="<%= @default_sets.length + 1 %>" onchange="set_changed(this)" id="default_sets">
					<%
						if not (@prev_data and @prev_data[:config]).nil?
							prev_sum = @prev_data[:config].sum
						else
							prev_sum = 0
						end
					%>
					<% @default_sets.each do |set| %>
						<option value="<%= set.id %>" data-subtext="&nbsp;<%= set.config %>" data-config=<%= set.config.to_json %> <%= (@prev_data and @prev_sum == set.config.sum) ? "selected" : "" %>><%= set.name %></option>
					<% end %>
					<% # if the config is not the default config? add it to the config set %>
					<% if @prev_data and @prev_data[:config] and not @default_sets.map { |s| @prev_sum == s.config.sum }.any? %>
						<option value="-1" data-subtext="&nbsp;<%= @prev_data[:config].map(&:to_i) %>" data-config=<%= @prev_data[:config].to_json %> selected>ست <%= @prev_data[:config].sum.to_i %> نفره</option>
					<% end %>
				</select>
			</td>
		</tr>
</table>
<blockquote class="rtl" style="border-right-color: #0088cc; ">
	<p>در صورتی که نمی‌خواهید از ست‌های پیش‌فرض استفاده کنید ست مورد نظر خود را در قسمت زیر تعریف کنید.</p>
	<p class="small" style="font-size: 100%">توجه کنید که هیچ محدودیتی در رابطه با تعداد و ست وجود ندارد «<strong>بطوری که شما حتی می‌توانید فقط ۱ عدد مبل ۱ نفره سفارش دهید</strong>»، هدف ما راحتی شما در انتخاب‌هایتان می‌باشد.</p>
</blockquote>
<table class="table" id="custom_set">
	<thead>
		<tr>
			<th class="col-md-2">سایز</th>
			<th class="col-md-1">تعداد (عدد)</th>
			<th class="col-md-9"></th>
		</tr>
	</thead>
	<tbody>
		<% @defined_pieces.each do |piece| %>
			<tr>
				<td>مبل <strong><%= piece.piece %> نفره</strong></td>
				<td>
					<%= number_field_tag "piece_#{piece.id}", 0, in: 0..10, class: 'piece_counts', data: { mult: piece.piece }, onchange: 'piece_changed()' %>
				</td>
				<td></td>
			</tr>
		<% end %>
		<tr>
			<td><strong>مجموع:</strong></td>
			<td id="pience-totall-sum"></td>
			<td></td>
		</tr>
	</tbody>
</table>

<%= render 'order/orders/shared/nav', prev_step: false %>

<script type="text/javascript" charset="utf-8">
	function piece_changed() {
		var sum = 0;
		$(".piece_counts").each(function() { sum += Number($(this).val()) * Number($(this).data('mult')); })
		$("#pience-totall-sum").html(sum + " نفره")
	}
	function set_config_pieces(config) {
		for(var k in config) {
			var el = "#custom_set input[name='piece_" + config[k] + "']";
			$(el).val(Number($(el).val()) + 1)
		}
		// flag the change
		piece_changed()
	}
	function set_changed(_this) {
		// reset numbers
		$(".piece_counts").val(0)
		// set config pieces
		set_config_pieces($(_this).find('option:selected').data('config'));
	}
	function build_order_details_step1() {
		return {
			config: $(".piece_counts").map(function() { return Array(Number($(this).val())).fill(Number($(this).data('mult'))) }).toArray()
		}
	}
	$(document).ready(function() {
		set_changed($("#default_sets"))
	});
</script>
