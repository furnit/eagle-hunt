<div id="step1">
	<legend>انتخاب طرح و رنگ پارچه</legend>
	<p style="border-right: 5px solid #0088cc; padding: 10px;">
		در این قسمت طرح و رنگ پارچه را برای قسمت‌های عمده‌ی مبل مشخص خواهید نمود.
	</p>
	<br />
	<div class="row">
		<div id="step1-1" class="text-centerx col-sm-3 col-xs-12 pull-right" style="padding-top: 130px">
			<div class="stepwizard">
				<% @furniture_sections.each.with_index do |s, index| %>
			    <div class="stepwizard-row <%= index == 0 ? :active : "" %>">
		        <div class="stepwizard-step">
	            <div class="btn btn-default btn-square" disabled></div>
		        </div>
						<strong class="stepwizard-label"><%= s.comment %></strong><br />
						<a href="#"><%= image_tag s.image[:image].thumb, height: "150px" %></a>
				    <%= raw index == @furniture_sections.length - 1 ? "" : "<hr />" %>
			    </div>
				<% end %>
			</div>
		</div>
		<div id="step1-2" class="col-sm-9 col-xs-12 pull-right">
			<div id="step1-2-options-header">
				<div class="row">
					<div class="col-md-3 pull-right form-group step1-2-options">
						<label for="fabric-quality">کیفیت پارچه:</label>
						<%= select_tag "fabric-quality", options_from_collection_for_select(@fabric_quals, :id, :name), prompt: "انتخاب کنید." %>
						<div style="margin-top: 10px" class='filters hidden'>
							<%= check_awesome "نمایش طرح‌های موجود", checked: false, id: 'only-show-availables' %>
						</div>
					</div>
					<div class="col-md-9 pull-right step1-2-options" style="border-right: 1px solid #aaa">
						<label>تیپ رنگی:</label><br />
						<small class="text-muted">طرح‌های مختلف را بر اساس دسته‌بندی رنگی آنها نمایش می‌دهد.</small><br />
						<% @colors_categories.each do |c| %>
							<div class="color-box shadow-box img-thumbnail" style="background-color: <%= c.value %>;" data-id="<%= c.id %>"></div>
						<% end %>
					</div>
				</div>
				<div class="clearfix"></div>
				<hr />
			</div>
			<div id="step1-2-content" class="photo-gallery-collection">
			</div>
		</div>
		<div id="step1-2-helper" class="text-center">
			<span class='fa fa-hand-o-up'></span> لطفا یکی از «کیفیت‌های پارچه» یا «تیپ رنگی» را جهت ادامه انتخاب کنید.
		</div>
	</div>
	<div id="step1-nav">
		<hr />
		<button class="btn btn-default pull-right hidden btn-prev">
			<span class="fa fa-arrow-right" style="margin-top: 3px"></span> قسمت قبل
		</button>
		<button class="btn btn-primary pull-left btn-next">
			قسمت بعد <span class="fa fa-arrow-left" style="margin-top: 3px"></span>
		</button>
		<div class="clearfix"></div>
	</div>
</div>

<div class="hidden" id="fabric-model-template">
	<div class="thumbnail hover-shadow">
		<!-- image_tag -->
    <div class="caption" style='padding: 20px; font-size: 120%'>
    	<table class="table no-layout">
    		<thead class="no-layout">
    			<tr>
    				<th style="text-align: right;"></th>
    				<th></th>
  				</tr>
  			</thead>
    		<tbody>
    			<tr>
    				<td>نام مدل</td>
    				<td class="model-name"></td>
    			</tr>
    			<tr>
    				<td>کیفیت</td>
    				<td class="model-quality"></td>
    			</tr>
    			<tr>
    				<td>قیمت</td>
    				<td class="model-price"></td>
    			</tr>
    			<tr>
    				<td>وضعیت</td>
    				<td class="model-status"><span class="label"></span></td>
    			</tr>
    		</tbody>
  		</table>
      <div class='clearfix'></div>
      <p style="position: relative; bottom: 0px" class="actions">
      	<%= link_to '#', class: 'info btn btn-primary pull-left select-fabric' do %>
      		<span class="fa fa-crosshairs"></span>
    			<span class="text">انتخاب طرح</span>
      	<% end %>
      	<div class='clearfix'></div>
    	</p>
    </div>
  </div> <!-- /.thumbnail -->
</div>

<script type="text/javascript" charset="utf-8">
	$(document).ready(function() {
		$("#step1").bind('activated', function() {
			$("#order-stages #step-nav").addClass('hidden')
		})
		$("#step1 #step1-nav .btn-next").click(function() {
			if($("#step1-1 .stepwizard .stepwizard-row:last").hasClass('active')) {
				$("#order-stages #step-nav")
					.removeClass('hidden')
					.find('.btn-next').click()
					return;
			}
			$("#step1-1 .stepwizard .stepwizard-row.active:not(:last-child)")
				.removeClass('active').addClass('completed')
				.find('.btn-square').html('<span class="fa fa-check"></span>')
				.closest('.stepwizard-row').next('.stepwizard-row').addClass('active');
			$("#order-stages #step1-nav .btn-prev").removeClass('hidden');
			$(this).blur();
		});
		$("#step1 #step1-nav .btn-prev").click(function() {
			$("#step1-1 .stepwizard .stepwizard-row.completed:last")
				.removeClass('completed').addClass('active')
				.find('.btn-square').html('')
				.closest('.stepwizard-row').next('.stepwizard-row.active').removeClass('active');
			if($("#step1-1 .stepwizard .stepwizard-row:first").hasClass('active')) $(this).addClass('hidden');
			$(this).blur();
		});
		$('#step1-1 li').click(function() {
			$(this).closest('ul').find('.active').removeClass('active');
			$(this).addClass('active');
			$('#step1-2-helper').removeClass('hidden');
			$('#step1-2').removeClass('hidden');
			$('#step1 #step1-2 #fabric-quality').prop('selectedIndex', 0);
		  $("#step1-2-content").html("");
		})
		var filter_availables = function() {
			if($(this).prop('checked')) {
				$('#step1-2-content .not-available').hide();
				// exculde it from photo-gallery
				$('#step1-2-content .not-available [data-type="photo-gallery"]')
					.removeAttr('data-type')
					.attr('xdata-type', 'photo-gallery')
			}
			else {
				$('#step1-2-content .not-available').show();
				// include it from photo-gallery
				$('#step1-2-content .not-available [xdata-type="photo-gallery"]')
					.removeAttr('xdata-type')
					.attr('data-type', 'photo-gallery')
			}
		};
		var reset_everything = function() {
			$("#step1-2-content").html("")
			$("#step1-2-helper").removeClass('hidden')
			$(".color-box.active").removeClass('active')
			$('#step1 #step1-2 #fabric-quality').prop('selectedIndex',0)
		};
		var load_fabrics = function(url, data) {
			// clear the content
		  $("#step1-2-content").html("");
			$('#step1-2-helper').addClass('hidden')
			$("#step1-2-content").html("<div class='text-center'><span class='fa fa-spinner fa-spin'></span></div>");
			$.ajax({
				url: url,
				data: data,
				method: 'post',
				success: function(data) {

					// clear the content
				  $("#step1-2-content").html("");
					if(data.length === 0) {
						$("#step1-2-content").html("<div class='text-center'><span class='fa fa-exclamation-triangle'></span> هیچ پارچه‌ای با این کیفیت در سیستم ثبت نشده است.</div>");
						return;
					}
					$('.step1-2-options .filters').removeClass('hidden')
					for(var i = 0, c = 0, j = data.length; i < j; i ++) {
						 var fabric = data[i];
						 $("#step1-2-content").append("<legend>" + fabric.brand.name + "</legend>");
						 var models = fabric.models

						 $("#step1-2-content").append("<div class='row'>");
			 			 if(!fabric.brand.available) {
			 				 $("#step1-2-content legend").last().addClass('not-available');
			 				 $("#step1-2-content .row").last().addClass('not-available');
			 			 }

						 for(var l = 0, k = models.length; l < k; l++, c++) {
						 		$("#step1-2-content .row").last().append("<div class='col-sm-3 text-center fab-container' style='margin: 0 32px 0 32px;'></div>");
						 		var $wrapper = $("#step1-2-content .row .fab-container").last();
						 		$wrapper.append($('#fabric-model-template').clone().removeAttr('id class'));
						 		$wrapper_box = $wrapper.find('.thumbnail');

						 		$wrapper_box.prepend("<a href='" + models[l].origin + "' data-type='photo-gallery' data-index='" + c.toString() + "' data-thumb='" + models[l].thumb + "'>\
						 			<img src='" + models[l].thumb + "' data-origin-src='" + models[l].origin + "' class='img img-responsive img-thumbnail' />\
					 			");
						 		$wrapper_box
						 			.find('.model-name').html("M-" + models[l].id);
						 		$wrapper_box
						 			.find('.model-quality').html(fabric.quality.name);
						 		$wrapper_box
						 			.find('.model-price').html(fabric.price);
						 		$wrapper_box.find('.model-status span.label')
						 			.html(fabric.brand.available ? 'موجود' : 'ناموجود')
						 			.addClass(fabric.brand.available ? 'label-success' : 'label-danger');
					 			if(!fabric.brand.available) {
					 				$wrapper_box.find('.actions').addClass('hidden');
					 				$wrapper.addClass('not-available');
				 				}
						 };
					};
					filter_availables();
					execute_photo_gallery();
					// highlight and scroll-to the viewing image
					$("[data-type='photo-gallery']").click(function(){
						var scroll_to = function(item) {
					    $("body").scrollTop($(item).offset().top - 70);
							return $(item);
						};

						$('.fab-container.active').removeClass('active');
						scroll_to($(this).closest('.fab-container')).addClass('active');
						setTimeout(function(){
							gallery.listen('afterChange', function() {
								$('.fab-container.active').removeClass('active');
								scroll_to($(gallery.items[gallery.getCurrentIndex()].item).closest('.fab-container')).addClass('active');
							});
						}, 500);
					})
				}
			});
		};
		$("#step1 #step1-nav .btn").click(reset_everything);
		$("#only-show-availables").click(filter_availables);
		$('#step1 #step1-2 #fabric-quality').change(function() {
			load_fabrics('<%= ls_fabrics_api_index_path %>', {q: $(this).find(':selected').val()})
			$('#step1 #step1-2 .color-box.active').removeClass('active');
		});
		$('#step1 #step1-2 .color-box[data-id]').click(function() {
			$('#step1 #step1-2 .color-box.active').removeClass('active');
			$(this).addClass('active')
			load_fabrics('<%= ls_fabric_models_api_index_path %>', {cc: $(this).data('id')})
		});
	});
</script>

<%= render 'shared/photo_gallery' %>