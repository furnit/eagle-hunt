<% specs = Admin::FurnitureSpec.where('name IN (?)', ['پارچه', 'ابر']) %>
<% sections = Admin::FurnitureSection.where('name IN (?)', ['زیری', 'پشتی', 'دسته']) %>
<% klass_counter = 0 %>
<% next_klass = Proc.new { klass_counter += 1; "kid=#{klass_counter}"  }%>
<% 
	def build_section **args
		render_thead = Proc.new { |thead| thead.each { |h| concat raw "<th>#{h}</th>" } }
		{
			thead: '',
			pangel_heading: '',
			panel_type: 'default'
		}.each { |k, v| args[k] ||= v }
%>
			<div class="panel panel-<%= raw args[:panel_type] %>">
			  <div class="panel-heading"><strong><%= raw args[:pangel_heading] %></strong></div>
			  <div class="panel-body">
			  	<table class="table table-striped">
			  		<thead><tr><% render_thead.call args[:thead] %></tr></thead>
			  		<tbody><% yield if block_given? %></tbody>
		  		</table>
			  </div>
			</div>
<% 
	end
%>


<div class='furniture-intel'>
	<%= acu_as :admin { render 'shared/editable_content' }%>
	<% # DAST MOZD HA %>
	<% build_section panel_type: 'success',
				pangel_heading: "<span class='fa fa-money'></span> دست‌مزد",
				thead: ['کارمند', 'دست‌مزد روکوب', 'دست‌مزد خیاط'] do %>
		<% 
			collection = { }
			[:wage_rokob, :wage_khayat].each do |label|
				collection[label] = intel.map {|i| i[:data][label]}
			end
		%>
		<% klass_id = next_klass.call %>
		<% intel.each do |i| %>
			<tr <%= klass_id %>>
				<td><%= i[:data].user.full_name %></td>
				<% [:wage_rokob, :wage_khayat].each do |label| %>
					<td>
						<% outlier_label i[:data][label], collection: collection[label] do %>
							<%= i[:data][label].to_i %>
						<% end %>
					</td>
				<% end %>
			</tr>
		<% end %>
	<% end %>
	
	<% # ZAMAN BANDI %>
	<% build_section panel_type: 'info',
				pangel_heading: "<span class='fa fa-clock-o'></span> زمان‌بندی",
				thead: ['کارمند', 'مدت‌ زمان پایان «خیاطی» و «روکوبی»'] do %>
		
		<% klass_id = next_klass.call %>
		<% intel.each do |i| %>
			<tr <%= klass_id %>>
				<td><%= i[:data].user.full_name %></td>
				<td>
					<% outlier_label i[:data][:days_to_complete], collection: intel.map { |i| i[:data][:days_to_complete] } do %>
						<%= i[:data][:days_to_complete] %>&nbsp;
						روز
					<% end %>
				</td>
			</tr>
		<% end %>
	<% end %>
	
	<% # ETELA'ATE UMUMI %>
	<% build_section panel_type: 'primary',
				pangel_heading: "<span class='fa fa-info'></span> اطلاعات عمومی",
				thead: ['کارمند', 'رنگ‌آمیزی دارد؟', 'کنده‌کاری دارد؟', 'کناف دارد؟'] do %>
		
		<% klass_id = next_klass.call %>
		<% intel.each do |i| %>
			<tr <%= klass_id %>>
				<td><%= i[:data].user.full_name %></td>
				<% [:needs_rang, :needs_kande, :needs_kanaf].each do |label| %>
					<td>
						<% outlier_label i[:data][label], collection: intel.map { |i| i[:data][label] }, categorical: true do %>
							<span class='fa fa-<%= i[:data][label] ? 'check' : 'times' %>'></span>
						<% end %>
					</td>
				<% end %>
			</tr>
		<% end %>
	<% end %>
	
	<% # JOZIYAT %>
	<% specs.each do |spec| %>
		<% is_abr = (spec.name == "ابر") %>
		<% thead = ['قسمت', 'کارمند', 'مقدار'] %>
		<% thead = ['قسمت', 'کارمند', 'جنس<br />(در حالت کلی)', 'مقدار'] if is_abr %>
		<% build_section panel_type: 'primary',
					pangel_heading: "<span class='fa fa-balance-scale'></span> جزییات #{spec.name}",
					thead: thead do %>
			<% sections.each do |section| %>
				<% details = [] %>
				<% intel.each.with_index do |i, index| %>
					<% details << i[:data].furniture_build_details.where(admin_furniture_spec_id: spec.id, admin_furniture_section_id: section.id).first %>
				<% end %>
				<% details_value = details.map { |d| d.value }%>
				<% klass_id = next_klass.call %>
				<% details.each.with_index do |detail, index| %>
					<% i = intel[index] %>
					<tr class="<%= index == 0 ? 'divider' : '' %>" <%= klass_id %>>
	      		<% if index == 0 %>
		      		<td rowspan="<%= intel.length %>">
								<%= image_tag thumbnail_url(section.images), \
											class: 'furniture-section img-responsive', \
											style: 'height: 80px;margin-top: 0px;', \
											title: section.comment %>
							</td>
						<% end %>
						<td><%= i[:data].user.full_name %></td>
						<% if is_abr %>
						<td>
							<% outlier_label detail.options["admin_furniture_stuff_abrs"]["id"], collection: details.map { |d| d.options["admin_furniture_stuff_abrs"]["id"] }, categorical: true do %>
								<%= Admin::FurnitureStuffAbr.find(detail.options["admin_furniture_stuff_abrs"]["id"]).name %>
							<% end %>
						</td>
						<% end %>
						<td>
							<% outlier_label detail.value, collection: details_value do%>
								<%= detail.value %>&nbsp;
								<%= spec.unit %>
							<% end %>
						</td>
					</tr>
				<% end %>
			<% end %>
		<% end %>
	<% end %>
	
	<div class='clearfix'></div>
</div>

<div class="alert alert-warning" role="alert">
	<span class='fa fa-info-circle fa-2x'></span>
	اطلاعاتی که با <span class='label label-danger'>رنگ پس‌زمینه‌ی فرمز</span> مشخص شده‌اند داده‌هایی هستند که سیستم با در نظر گرفتن دیگر داده‌ها، <b>«مشکوک» به اشتباه بودن آن‌ها</b> است؛ این بستگی به مدیریت سیستم دارد که این داده‌ها را <b>تایید</b> یا <b>ویرایش</b> نماید.
</div>

<script type="text/javascript" charset="utf-8">
	$('.furniture-section').on('mouseover', function(e) {
		$(this).popover({
      html: true,
      trigger: 'hover',
      placement: 'bottom',
      content: function(){ return '<img src="'+$(this).attr('src') + '" />';}
    });
    $(this).popover('show');
  });
  $('.furniture-intel tr td').has('.label').hover(function(){
  	row    = $(this).closest('tr')
  	column = $(this).closest('td')
  	if($('tr[kid="' + row.attr('kid') + '"]').hasClass('divider')) {
  		if(row.hasClass('divider')) {
  			console.log('shit')
  			column.find('.label').addClass('kid-effect')
		  	$('tr[kid="' + row.attr('kid') + '"]').not(row).find('td:nth-child(' + (column.index()) + ') .label').addClass('kid-effect');
			} else {	
		  	$('tr[kid="' + row.attr('kid') + '"]').not('.divider').find('td:nth-child(' + (column.index() + 1) + ') .label').addClass('kid-effect');
		  	$('tr.divider[kid="' + row.attr('kid') + '"]').find('td:nth-child(' + (column.index() + 2) + ') .label').addClass('kid-effect');
			}
  	} else {
  		$('tr[kid="' + row.attr('kid') + '"] td:nth-child(' + (column.index() + 1) + ') .label').addClass('kid-effect');
  	}
  	$('.furniture-intel tr .label:not(.kid-effect)').css('opacity', 0.1);
  }, function(){
  	$('.furniture-intel tr .label').css('opacity', 1).removeClass('kid-effect')
  });
</script>

<style type="text/css" media="screen">
	.kid-effect {
		-webkit-box-shadow:0 0 20px #0088cc; 
    -moz-box-shadow: 0 0 20px #0088cc; 
    box-shadow:0 0 20px #0088cc;
	}
</style>
