<% outlier_color = 'danger' %>
<% outlier_text  = 'data-toggle="tooltip" title="سیستم این مقدار را در تناسب با دیگر مقادیر غیر عادی تشخیص داده است"' %>
<% specs = Admin::FurnitureSpec.where('name IN (?)', ['پارچه', 'ابر']) %>
<% sections = Admin::FurnitureSection.where('name IN (?)', ['زیری', 'پشتی', 'دسته']) %>
<% 
	def build_section **args
		render_thead = Proc.new { |thead| thead.each { |h| concat raw "<th>#{h}</th>" } }
		{
			thead: '',
			pangel_heading: '',
			panel_type: 'default'
		}.each { |k, v| args[k] ||= v }
%>
			<div class="panel panel-<%= raw args[:panel_type] %>">
			  <div class="panel-heading"><strong><%= raw args[:pangel_heading] %></strong></div>
			  <div class="panel-body">
			  	<table class="table table-striped">
			  		<thead><tr><% render_thead.call args[:thead] %></tr></thead>
			  		<tbody><% yield if block_given? %></tbody>
		  		</table>
			  </div>
			</div>
<% 
	end
%>

<div>
	<% # DAST MOZD HA %>
	<% build_section panel_type: 'success',
				pangel_heading: "<span class='fa fa-money'></span> دست‌مزد",
				thead: ['کارمند', 'دست‌مزد روکوب', 'دست‌مزد خیاط'] do %>
		<% 
			collection = { }
			[:wage_rokob, :wage_khayat].each do |label|
				collection[label] = intel.map {|i| i[:data][label]}
			end
		%>
		<% intel.each do |i| %>
			<% is_outlier = { } %>
			<% [:wage_rokob, :wage_khayat].each { |label| is_outlier[label] = is_outlier?(i[:data][label], collection: collection[label]) } %>
			<tr <%= raw is_outlier.values.any? ? outlier_text : "" %>>
				<td><%= i[:data].user.full_name %></td>
				<% [:wage_rokob, :wage_khayat].each do |label| %>
					<td <%= raw is_outlier[label] ? "class='#{outlier_color}'" : "" %>><%= i[:data][label] %></td>
				<% end %>
			</tr>
		<% end %>
	<% end %>
	
	<% # ZAMAN BANDI %>
	<% build_section panel_type: 'info',
				pangel_heading: "<span class='fa fa-clock-o'></span> زمان‌بندی",
				thead: ['کارمند', 'مدت‌ زمان پایان «خیاطی» و «روکوبی»'] do %>
		
		<% intel.each do |i| %>
			<tr <%= raw is_outlier?(i[:data][:days_to_complete], collection: intel.map {|i| i[:data][:days_to_complete] }) ? "class='#{outlier_color}' #{outlier_text}" : "" %>>
				<td><%= i[:data].user.full_name %></td>
				<td><%= i[:data][:days_to_complete] %>&nbsp;روز</td>
			</tr>
		<% end %>
	<% end %>
	
	<% specs.each do |spec| %>
		<% is_abr = (spec.name == "ابر") %>
		<% thead = ['کارمند', 'قسمت', 'مقدار'] %>
		<% thead = ['کارمند', 'قسمت', 'جنس<br />(در حالت کلی)', 'مقدار'] if is_abr %>
		<% build_section panel_type: 'primary',
					pangel_heading: "<span class='fa fa-balance-scale'></span> جزییات #{spec.name}",
					thead: thead do %>
			<% intel.each do |i| %>
				<% sections.each.with_index do |section, index| %>
					<% detail = i[:data].furniture_build_details.where(admin_furniture_spec_id: spec.id, admin_furniture_section_id: section.id).first %>
					<tr <%= raw index == 0 ? 'class="divider"' : '' %>>
						<% if index == 0 %>
							<td rowspan="<%= sections.length %>"><%= i[:data].user.full_name %></td>
						<% end %>
	      		<td>
							<%= image_tag thumbnail_url(section.images), \
										class: 'furniture-section img-responsive', \
										style: 'height: 40px;margin-top: 0px;', \
										title: section.comment %>
						</td>
						<% if is_abr %>
						<td><%= Admin::FurnitureStuffAbr.find(detail.options["admin_furniture_stuff_abrs"]["id"]).name %></td>
						<% end %>
						<td>
							<%= detail.value %>
							<%= spec.unit %>
						</td>
					</tr>
				<% end %>
			<% end %>
		<% end %>
	<% end %>
	
	<div class='clearfix'></div>
</div>

<script type="text/javascript" charset="utf-8">
	$('.furniture-section').on('mouseover', function(e) {
		$(this).popover({
      html: true,
      trigger: 'hover',
      placement: 'bottom',
      content: function(){ return '<img src="'+$(this).attr('src') + '" />';}
    });
    $(this).popover('show');
  });
</script>
